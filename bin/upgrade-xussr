#!/bin/bash
_NEWGRF_PATH="$HOME/.openttd/newgrf/"
[ ! -e "${_NEWGRF_PATH}xussr.tar" ] && rm -f "${_NEWGRF_PATH}.xussr.ver"

_VERSION_DATA=$(curl -sL http://bundles.openttdcoop.org/xussrset/push/LATEST/custom_tags.txt)
_XUSSR_REMOTE=$( grep NEWGRF_VERSION <<<"$_VERSION_DATA" | cut -f2 -d':' )
_XUSSR_DATE=$( grep REPO_DATE <<<"$_VERSION_DATA" | cut -f2 -d':' )
_XUSSR_INSTALLED=$(<"${_NEWGRF_PATH}.xussr.ver") 2>/dev/null && echo "Local xUSSR Set version: r${_XUSSR_INSTALLED}"
echo "Remote xUSSR Set version: r$_XUSSR_REMOTE, released at ${_XUSSR_DATE}"

[ ! -e "${_NEWGRF_PATH}xussr.tar" ] && _XUSSR_INSTALLED=""
if [ "${_XUSSR_INSTALLED}" != "${_XUSSR_REMOTE}" ]; then
  echo "Downloading xUSSR Set r${_XUSSR_REMOTE}..."
  curl -qL "http://bundles.openttdcoop.org/xussrset/push/LATEST/xussr-r${_XUSSR_REMOTE}.zip" | funzip > "${_NEWGRF_PATH}xussr.tar"
  echo "${_XUSSR_REMOTE}" > "${_NEWGRF_PATH}.xussr.ver"
  echo "Downloaded xUSSR Set r${_XUSSR_REMOTE} (released ${_XUSSR_DATE})"
  echo "View changelog at http://dev.openttdcoop.org/projects/xussrset/repository/changes"
else
  echo "Nothing to do"
fi
